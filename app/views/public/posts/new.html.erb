<div class="background container py-5 rounded">
  <div class="row">
    <div class="col-10 mx-auto">
      <!--タイトル-->
      <div class="row mb-4">
        <div class="title p-2 rounded">
          <h3 class="mx-2 my-0">新規投稿</h3>
        </div>
      </div>

      <!--投稿フォーム-->
      <%= form_with model: @post do |f| %>
        <%= render "form", post: @post, f: f %>

        <!--地図投稿フォーム-->
        <div class="form-group">
          <%= f.label :map, "地図" %>

          <!--地図検索フォーム-->
          <div class="d-flex">
            <input id="address" class="form-control" type="text" placeholder="地名検索">
            <input type="button" value="検索" onclick="codeAddress()">
          </div>
        </div>

        <!--地図の表示-->
        <div class="form-group">
          <div id='map'></div>
        </div>

        <!--投稿ボタン-->
        <div class="form-group text-center pt-5">
            <%= f.submit "投稿", class: "button-blue btn col-sm-3 col-5" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- js部分 -->
<script>
  //mapが正しく表示されるための記述
  if (window.google){
    initMap();
  } else {
    $.ajax('https://maps.googleapis.com/maps/api/js?key=<%= ENV["GOOGLE_MAP_API_KEY"] %>&callback=initMap&libraries=places', {
      crossDomain: true,
      dataType: 'script'
    });
  }

  //初期マップの設定
  var map
  var marker
  function initMap(){
    geocoder = new google.maps.Geocoder()

    map = new google.maps.Map(document.getElementById('map'), {
      center:  {lat:35.710006892117, lng:139.81081025188},  //東京スカイツリー
      zoom: 15,
    });

    //検索フォーム
    var input = document.getElementById("address");
    var searchBox = new google.maps.places.SearchBox(input);

    map.addListener("bounds_changed", () => {
      searchBox.setBounds(map.getBounds());
    });
  }

  //検索後のマップ作成
  var geocoder
  var aft
  function codeAddress(){
    var inputAddress = document.getElementById('address').value;
    geocoder.geocode( { 'address': inputAddress}, function(results, status) {
      if (status == 'OK') {
          //マーカーが複数できないようにする
          if (aft == true){
              marker.setMap(null);
          }

          //新しくマーカーを作成する
          map.setCenter(results[0].geometry.location);
              marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location,
              draggable: true // ドラッグ可能にする
          });

          //二度目以降か判断
          aft = true

          //検索した時に緯度経度を入力する
          document.getElementById('lat').value = results[0].geometry.location.lat();
          document.getElementById('lng').value = results[0].geometry.location.lng();

          // マーカーのドロップ（ドラッグ終了）時のイベント
          google.maps.event.addListener( marker, 'dragend', function(ev){
              // イベントの引数evの、プロパティ.latLngが緯度経度
              document.getElementById('lat').value = ev.latLng.lat();
              document.getElementById('lng').value = ev.latLng.lng();
          });
      } else {
        alert('該当する結果がありませんでした');
      }
    });
  }
</script>